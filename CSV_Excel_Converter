#!/usr/bin/env python3
"""
CSV to Excel Converter with Data Cleaning

This script reads a CSV file, performs basic data cleaning and normalization,
and exports the data to an Excel (.xlsx) file.

Features:
- Handles missing values by dropping rows with NaN
- Normalizes column names by stripping whitespace
- Simple column renaming (customize rename_dict)
- Basic data parsing for date columns
- CLI interface with input and output flags
- Logging for operations and errors
"""

import pandas as pd
import argparse
import logging
import sys

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def clean_data(df):
    """
    Perform data cleaning and normalization.
    """
    logging.info('Starting data cleaning...')

    # Handle missing values: drop rows with any missing values
    original_shape = df.shape
    df = df.dropna()
    logging.info(f'Dropped {original_shape[0] - df.shape[0]} rows with missing values.')

    # Normalize column names: strip whitespace and convert to lower case
    df.columns = df.columns.str.strip().str.lower()
    logging.info('Normalized column names.')

    # Simple column renames (customize as needed)
    rename_dict = {
        # 'old_column_name': 'new_column_name',
        # Example: 'First Name': 'first_name'
    }
    df = df.rename(columns=rename_dict)
    if rename_dict:
        logging.info(f'Renamed columns: {rename_dict}')

    # Data parsing: convert date columns if present
    date_columns = ['date', 'created_at', 'updated_at']  # Add more as needed
    for col in date_columns:
        if col in df.columns:
            try:
                df[col] = pd.to_datetime(df[col], errors='coerce')
                logging.info(f'Parsed dates in column: {col}')
            except Exception as e:
                logging.warning(f'Could not parse dates in {col}: {e}')

    logging.info('Data cleaning completed.')
    return df

def main():
    parser = argparse.ArgumentParser(
        description='Convert CSV to Excel with data cleaning.'
    )
    parser.add_argument(
        '-i', '--input',
        required=True,
        help='Path to the input CSV file'
    )
    parser.add_argument(
        '-o', '--output',
        required=True,
        help='Path to the output Excel file (.xlsx)'
    )

    args = parser.parse_args()

    try:
        logging.info(f'Reading CSV file: {args.input}')
        df = pd.read_csv(args.input)
        logging.info(f'CSV read successfully. Shape: {df.shape}')
    except FileNotFoundError:
        logging.error(f'Input file not found: {args.input}')
        sys.exit(1)
    except pd.errors.EmptyDataError:
        logging.error(f'CSV file is empty: {args.input}')
        sys.exit(1)
    except Exception as e:
        logging.error(f'Error reading CSV file: {e}')
        sys.exit(1)

    # Clean the data
    df = clean_data(df)

    try:
        logging.info(f'Exporting to Excel: {args.output}')
        df.to_excel(args.output, index=False, engine='openpyxl')
        logging.info('Export to Excel successful.')
    except Exception as e:
        logging.error(f'Error exporting to Excel: {e}')
        sys.exit(1)

if __name__ == '__main__':
    main()